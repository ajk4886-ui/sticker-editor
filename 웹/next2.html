<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Sticker Editor (Stable)</title>
<style>
  body { margin:0; display:flex; font-family:Arial, sans-serif; user-select:none; }
  #left-panel { width:500px; border-right:2px solid #ccc; padding:15px; }
  .logo { font-size:48px; font-weight:700; margin-bottom:20px; color:#000; display:block; text-decoration:none; }
  .sub-title { font-size:20px; font-weight:600; margin-bottom:12px; }

  /* ë²„íŠ¼ ì´ë¯¸ì§€ */
  .select-btn { width:150px; cursor:pointer; margin-right:8px; }
  

  
  .popup-style {
  position:absolute;
  display:none;
  background:#fff;
  padding:10px;
  border-radius:8px;
  box-shadow:0 0 20px rgba(0,0,0,.2);

  /* â­ í•µì‹¬ */
  width:fit-content;
  height:fit-content;
}

.popup-style .popup-thumb{
  width:auto;
  height:auto;
  margin:4px;
  display:block;     /* ì„¸ë¡œ ì •ë ¬ */
}


  .closeBtn {
    position:absolute; top:6px; right:6px; width:22px; height:22px;
    border:2px solid #000; background:#fff; text-align:center; line-height:18px; font-weight:bold; cursor:pointer;
    display:inline-flex; align-items:center; justify-content:center;
  }

  #selected-window {
    position:fixed; width:320px; padding:12px; background:#fff; border:2px solid #000; display:none; z-index:2000; height: 500px;
  }
#selected-preview-real { 
  width:300px; 
  height:auto;       /* ê³ ì • ë†’ì´ ì œê±° */
  min-height:280px;  /* ìµœì†Œ ë†’ì´ë§Œ ìœ ì§€ */
  position:relative; 
  overflow:visible;  /* ì˜ë¦¼ ë°©ì§€ */
}
#applyStickerBtn {
  position: absolute;
  left: 20px;   /* ì™¼ìª½ì—ì„œ ê±°ë¦¬ */
  bottom: 20px; /* ì•„ë˜ì—ì„œ ê±°ë¦¬ */

  padding: 8px;
  border: 2px solid #000;
  background: #eee;
  text-align: center;
  cursor: pointer;
}

  #right-panel { flex:1; padding:20px; }
  #upload-box { width:100%; height:550px; border:3px dashed #aaa; background:#f5f5f5; position:relative; overflow:hidden; display:flex; align-items:center; justify-content:center; }
  #bg-image { position:absolute; max-width:100%; max-height:100%; pointer-events:none; }

  .sticker-wrapper { position:absolute; width:200px; transform-origin:center center; }
  .sticker-wrapper img { width:100%; display:block; pointer-events:none; user-select:none; }
  .resize-handle { width:18px; height:18px; background:#fff; border:2px solid #000; position:absolute; right:-10px; bottom:-10px; cursor:se-resize; }
  .control-btn { position:absolute; top:-12px; width:22px; height:22px; border:2px solid #000; background:#fff; text-align:center; cursor:pointer; display:flex; align-items:center; justify-content:center; }
  .rotate-btn { right:20px; } .delete-btn { right:-12px; }
  /* CAMERA */
#camera-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:5000;
}
#camera-box{
  background:#fff;
  padding:12px;
  border:2px solid #000;
}
#camera-box video{
  width:360px;
  display:block;
  margin-bottom:8px;
}


</style>
</head>
<body>
    
    
  <div id="left-panel">
    <a class="logo" href="index.html">M3m3tick3r</a>
    <div class="sub-title">S3l3ct sourc3 3motion</div>

    <!-- ì„ íƒ ë²„íŠ¼ë“¤ -->
    <img src="select.png" id="btn0" class="select-btn" alt="select0">
    <img src="select_1.png" id="btn1" class="select-btn" alt="select1">
    <img src="select_2.png" id="btn2" class="select-btn" alt="select2">

    <!-- íŒì—… 1 -->
    <div id="popup0" class="popup-style" aria-hidden="true">
      <div class="closeBtn" data-for="popup0">Ã—</div>
      <!-- ì—¬ëŸ¬ ì¸ë„¤ì¼(í´ë¦­í•˜ë©´ ë‘ë²ˆì§¸ íŒì—…ì´ ëœ¸) -->
      <img class="popup-thumb" src="img_3.png" data-list='[{"src":"img_3_2.png","left":100,"top":250}]'>
      <img class="popup-thumb" src="img_11.png" data-list='[{"src":"img_11_3.png","left":120,"top":180}, {"src":"img_11_2.png","left":120,"top":450}]'>
      <img class="popup-thumb" src="img_9.png" data-list='[{"src":"img_9_2.png","left":100,"top":250}]'>
      <img class="popup-thumb" src="img_13.png" data-list='[{"src":"img_13.png","left":120,"top":180}]'>
       <img class="popup-thumb" src="img_14.png" data-list='[{"src":"img_14.png","left":120,"top":180}]'>
       <img class="popup-thumb" src="img_15_1.png" data-list='[{"src":"img_15.png","left":120,"top":160},{"src":"img_15_2.png","left":120,"top":250} ]'>
       <img class="popup-thumb" src="img_16.png" data-list='[{"src":"img_16.png","left":120,"top":180}]'>
       <img class="popup-thumb" src="img_17.png" data-list='[{"src":"img_17.png","left":120,"top":250},{"src":"img_17_2.png","left":120,"top":250} ]'>
       <img class="popup-thumb" src="img_18.png" data-list='[{"src":"img_18.png","left":120,"top":180}]'>
        <img class="popup-thumb" src="img_34.png" data-list='[{"src":"img_34.png","left":120,"top":400},{"src":"img_34_2.png","left":120,"top":180} ]'>
       
       
    </div>

    <!-- íŒì—… 2 -->
    <div id="popup1" class="popup-style" aria-hidden="true">
      <div class="closeBtn" data-for="popup1">Ã—</div>
      <img class="popup-thumb" src="img_10.png" data-list='[{"src":"img_10_1.png","left":120,"top":180},{"src":"img_10.png","left":120,"top":450}]' alt="p1-1">
      <img class="popup-thumb" src="img_5.png" data-list='[{"src":"img_5.png","left":120,"top":250}]'>
      <img class="popup-thumb" src="img_12.png" data-list='[{"src":"img_12_2.png","left":120,"top":250},{"src":"img_12_3.png","left":120,"top":250} ]'>
      <img class="popup-thumb" src="img_6.png" data-list='[{"src":"img_6.png","left":120,"top":250}]'>
      <img class="popup-thumb" src="img_2.png" data-list='[{"src":"img_2_2.png","left":120,"top":350},{"src":"img_2_3.png","left":120,"top":180} ]'>
      <img class="popup-thumb" src="img_19.png" data-list='[{"src":"img_19.png","left":120,"top":250}]'>
      <img class="popup-thumb" src="img_20.png" data-list='[{"src":"img_20.png","left":120,"top":400},{"src":"img_20_2.png","left":120,"top":180} ]'>
      <img class="popup-thumb" src="img_21.png" data-list='[{"src":"img_21.png","left":120,"top":250}]'>
      <img class="popup-thumb" src="img_22.png" data-list='[{"src":"img_22.png","left":120,"top":400},{"src":"img_22_2.png","left":120,"top":180} ]'>
       <img class="popup-thumb" src="img_23.png" data-list='[{"src":"img_23.png","left":120,"top":400},{"src":"img_23_2.png","left":120,"top":180} ]'>
       <img class="popup-thumb" src="img_32.png" data-list='[{"src":"img_32_2.png","left":120,"top":300},{"src":"img_32.png","left":120,"top":180} ]'>
      
       

    </div>

    

    <!-- íŒì—… 3 -->
    <div id="popup2" class="popup-style" aria-hidden="true">
      <div class="closeBtn" data-for="popup2">Ã—</div>
      <img class="popup-thumb" src="img_7.png" data-list='[{"src":"img_7.png","left":120,"top":180},{"src":"img_7_2.png","left":120,"top":250}]'>
      <img class="popup-thumb" src="img_24.png" data-list='[{"src":"img_24.png","left":120,"top":250}]'>
      <img class="popup-thumb" src="img_25.png" data-list='[{"src":"img_25.png","left":120,"top":250}]'>
      <img class="popup-thumb" src="img.png" data-list='[{"src":"img_1.png","left":120,"top":170},{"src":"img_1_1.png","left":120,"top":280},{"src":"img_1_3.png","left":120,"top":460} ]'>
      <img class="popup-thumb" src="img_26.png" data-list='[{"src":"img_26.png","left":120,"top":170},{"src":"img_26_2.png","left":120,"top":280},{"src":"img_26_3.png","left":120,"top":300} ]'>
      <img class="popup-thumb" src="img_27.png" data-list='[{"src":"img_27_2.png","left":120,"top":180},{"src":"img_27.png","left":120,"top":400}]'>
      <img class="popup-thumb" src="img_28.png" data-list='[{"src":"img_28_2.png","left":120,"top":180},{"src":"img_28.png","left":120,"top":400}]'>
      <img class="popup-thumb" src="img_29.png" data-list='[{"src":"img_29.png","left":120,"top":180},{"src":"img_29_2.png","left":120,"top":250}]'>
      <img class="popup-thumb" src="img_30_2.png" data-list='[{"src":"img_30_1.png","left":120,"top":180},{"src":"img_30.png","left":120,"top":300}]'>
      <img class="popup-thumb" src="img_31.png" data-list='[{"src":"img_31.png","left":190,"top":180},{"src":"img_31_2.png","left":30,"top":300}]'>
      <img class="popup-thumb" src="img_33.png" data-list='[{"src":"img_33.png","left":120,"top":140},{"src":"img_33_2.png","left":120,"top":300}]'>
    </div>
  </div>

  <!-- ë‘ë²ˆì§¸(ì„¸ë¶€) íŒì—…: ì„ íƒ ë¯¸ë¦¬ë³´ê¸° -->
  <div id="selected-window" role="dialog" aria-hidden="true">
    <div class="closeBtn" id="close-selected-window">Ã—</div>
    <div id="selected-preview-real"></div>
    <div id="applyStickerBtn">Us3 this Stick3r</div>
  </div>

  <div id="right-panel">
    <button id="uploadBtn">Upload Imag3</button> <button id="cameraBtn">ğŸ“· Camera</button>
    <!-- Background Color Picker -->
<div style="margin:10px 0;">
  <label for="bg-color" style="margin-right:6px;">Background Color</label>
  <input type="color" id="bg-color" value="#f5f5f5">
  <button id="clear-bg-color">Reset</button>
</div>

    

    <input type="file" id="bg-upload" accept="image/*" style="display:none">
    <div id="upload-box">Drag & Drop imag3 h3r3
      <img id="bg-image" alt="">
    </div>
    <button id="saveBtn">sav3</button>
  </div>

<script>
document.addEventListener('DOMContentLoaded', ()=> {
  console.log('DOM loaded');

  // upload / drop background
  const uploadBox = document.getElementById('upload-box');
  const bgUpload = document.getElementById('bg-upload');
  const bgImage = document.getElementById('bg-image');

  document.getElementById('uploadBtn').addEventListener('click', ()=> bgUpload.click());
  bgUpload.addEventListener('change', e => { if(e.target.files[0]) readBG(e.target.files[0]); });
  uploadBox.addEventListener('dragover', e => e.preventDefault());
  uploadBox.addEventListener('drop', e => { e.preventDefault(); if(e.dataTransfer.files[0]) readBG(e.dataTransfer.files[0]); });

  function readBG(file){
    const r = new FileReader();
    r.onload = ev => { bgImage.src = ev.target.result; };
    r.readAsDataURL(file);
  }
// background color picker
const bgColorInput = document.getElementById('bg-color');
const clearBgColorBtn = document.getElementById('clear-bg-color');

bgColorInput.addEventListener('input', () => {
  uploadBox.style.background = bgColorInput.value;
});

clearBgColorBtn.addEventListener('click', () => {
  uploadBox.style.background = '#f5f5f5';
  bgColorInput.value = '#f5f5f5';
});

  // map buttons to popup ids
  const map = { btn0:'popup0', btn1:'popup1', btn2:'popup2' };
  Object.keys(map).forEach(btnId => {
    const btn = document.getElementById(btnId);
    if(!btn) return;
    btn.addEventListener('click', ()=>{
      console.log('open popup:', map[btnId]);
      // hide others
      document.querySelectorAll('.popup-style').forEach(p=> { p.style.display='none'; p.setAttribute('aria-hidden','true'); });
      const pop = document.getElementById(map[btnId]);
      pop.style.display = 'block';
      pop.setAttribute('aria-hidden','false');
    });
  });

  // close buttons inside each popup
  document.querySelectorAll('.popup-style').forEach(popup=>{
    const close = popup.querySelector('.closeBtn');
    if(close){
      close.addEventListener('click', ()=> {
        popup.style.display='none';
        popup.setAttribute('aria-hidden','true');
        document.getElementById('selected-window').style.display='none';
        document.getElementById('selected-window').setAttribute('aria-hidden','true');
      });
    }
  });

  // close selected-window
  document.getElementById('close-selected-window').addEventListener('click', ()=>{
    document.getElementById('selected-window').style.display='none';
    document.getElementById('selected-window').setAttribute('aria-hidden','true');
  });

  // when thumb inside any popup clicked -> show selected-window (use event delegation)
  document.querySelectorAll('.popup-style').forEach(popup=>{
    popup.addEventListener('click', (ev)=>{
      const t = ev.target;
      if(!t.classList.contains('popup-thumb')) return;
      try {
        const list = JSON.parse(t.dataset.list || '[]');
        const rect = t.getBoundingClientRect();
        const win = document.getElementById('selected-window');
        // ê¸°ì¡´: win.style.left = rect.left + 'px';
// ê¸°ì¡´: win.style.top  = (rect.bottom + 8) + 'px';
// ê¸°ì¡´: win.style.display = 'block';

// ëŒ€ì²´í•  ì•ˆì „í•œ ìœ„ì¹˜ ê³„ì‚° ì½”ë“œ -> ì´ë¯¸ì§€ ì˜¤ë¥¸ìª½ì— ë„ìš°ê³ , í™”ë©´ì„ ë²—ì–´ë‚˜ë©´ ì™¼ìª½ìœ¼ë¡œ ì „í™˜
const gap = 8; // ì´ë¯¸ì§€ì™€ íŒì—… ì‚¬ì´ ê°„ê²©

// ë¨¼ì € ë³´ì´ê²Œ í•´ì„œ offsetWidth/offsetHeightë¥¼ ì–»ì„ ìˆ˜ ìˆê²Œ í•¨
win.style.display = 'block';
win.setAttribute('aria-hidden','false');

// ë„ˆë¹„/ë†’ì´ ì–»ê¸°
const popupW = win.offsetWidth || 300;
const popupH = win.offsetHeight || 200;

// ê¸°ì¤€ rect (ì´ë¯¸ì§€ ë°•ìŠ¤)
const winRight = rect.right;
const winLeft = rect.left;
const winTop = rect.top;

// ê¸°ë³¸ ìœ„ì¹˜: ì´ë¯¸ì§€ ì˜¤ë¥¸ìª½, ì´ë¯¸ì§€ì˜ top ë§ì¶¤
let left = Math.round(winRight + gap);
let top  = Math.round(winTop);

// ë§Œì•½ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë°°ì¹˜í–ˆì„ ë•Œ í™”ë©´ ì˜¤ë¥¸ìª½ì„ ë²—ì–´ë‚˜ë©´
if (left + popupW > window.innerWidth - 8) {
  // ì™¼ìª½ì— ë¶™ì—¬ì„œ ë³´ì—¬ì¤Œ
  left = Math.round(winLeft - popupW - gap);
}

// í™”ë©´ ì™¼ìª½ìœ¼ë¡œë„ ë²—ì–´ë‚˜ë©´ ìµœì†Œê°’ìœ¼ë¡œ ê³ ì •
if (left < 8) left = 8;

// ì„¸ë¡œë¡œ í™”ë©´ì„ ë²—ì–´ë‚˜ë©´ ìœ„ë¡œ ë‹¹ê¸°ê¸°
if (top + popupH > window.innerHeight - 8) {
  top = Math.max(8, window.innerHeight - popupH - 8);
}

// ì ìš©
win.style.left = left + 'px';
win.style.top  = top  + 'px';

        win.setAttribute('aria-hidden','false');

        // build preview
        const preview = document.getElementById('selected-preview-real');
        preview.innerHTML = '';
        preview.style.position = 'relative';
        list.forEach(obj => {
          const p = document.createElement('img');
          p.src = obj.src;
          p.style.position = 'absolute';
          p.style.left = (obj.left - 100) + 'px';
          p.style.top  = (obj.top  - 150) + 'px';
          p.style.width = '300px';
          p.style.pointerEvents = 'none';
          preview.appendChild(p);
        });

        // apply button
        document.getElementById('applyStickerBtn').onclick = ()=> {
          list.forEach(o => addSticker(o));
        };
      } catch(err){
        console.error('invalid data-list JSON', err, t.dataset.list);
      }
    });
  });

  // add sticker function
  function addSticker(obj){
    const w = document.createElement('div');
    w.className = 'sticker-wrapper';
    w.style.left = obj.left + 'px';
    w.style.top  = obj.top  + 'px';
    w.dataset.rotate = '0';

    const img = document.createElement('img');
    img.src = obj.src;
    img.alt = '';
    img.draggable = false;
    img.style.width = '100%';

    const handle = document.createElement('div');
    handle.className = 'resize-handle';

    const del = document.createElement('div');
    del.className = 'control-btn delete-btn';
    del.textContent = 'Ã—';

    const rot = document.createElement('div');
    rot.className = 'control-btn rotate-btn';
    rot.textContent = 'âŸ³';

    w.appendChild(img);
    w.appendChild(handle);
    w.appendChild(del);
    w.appendChild(rot);

    uploadBox.appendChild(w);

    makeDraggable(w);
    makeResizable(w, handle);
  }

  // event delegation for delete / rotate
  uploadBox.addEventListener('click', (e)=>{
    const t = e.target;
    if(t.classList.contains('delete-btn')){
      const wrap = t.closest('.sticker-wrapper');
      if(wrap) wrap.remove();
    } else if(t.classList.contains('rotate-btn')){
      const wrap = t.closest('.sticker-wrapper');
      if(wrap){
        let a = Number(wrap.dataset.rotate||0) + 15;
        wrap.dataset.rotate = a;
        wrap.style.transform = `rotate(${a}deg)`;
      }
    }
  });

  // drag move
  function makeDraggable(el){
    let down = false, offX=0, offY=0;
    el.addEventListener('mousedown', e=>{
      // ignore clicks on controls / handles
      if(e.target.classList.contains('resize-handle') || e.target.classList.contains('control-btn')) return;
      down = true;
      const r = el.getBoundingClientRect();
      offX = e.clientX - r.left;
      offY = e.clientY - r.top;
      el.style.zIndex = (Number(el.style.zIndex||10)+1);
      e.preventDefault();
    });
    document.addEventListener('mouseup', ()=> down=false);
    document.addEventListener('mousemove', e=>{
      if(!down) return;
      const boxRect = uploadBox.getBoundingClientRect();
      let nx = e.clientX - boxRect.left - offX;
      let ny = e.clientY - boxRect.top  - offY;
      // clamp (optional)
      if(nx < -300) nx = -300;
      if(ny < -300) ny = -300;
      el.style.left = nx + 'px';
      el.style.top  = ny + 'px';
    });
  }

  // resize handle
  function makeResizable(el, handle){
    let resizing = false;
    handle.addEventListener('mousedown', (e)=> { resizing = true; e.stopPropagation(); e.preventDefault(); });
    document.addEventListener('mouseup', ()=> resizing = false);
    document.addEventListener('mousemove', (e)=>{
      if(!resizing) return;
      const rect = el.getBoundingClientRect();
      let newW = e.clientX - rect.left;
      if(newW < 30) newW = 30;
      el.style.width = newW + 'px';
    });
  }

  // save composition to canvas
  document.getElementById('saveBtn').addEventListener('click', ()=>{
    const canvas = document.createElement('canvas');
    canvas.width  = uploadBox.clientWidth;
    canvas.height = uploadBox.clientHeight;
    const ctx = canvas.getContext('2d');

    // white bg
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);

    // draw background (object-fit:contain)
    if(bgImage && bgImage.src){
      const bw = bgImage.naturalWidth, bh = bgImage.naturalHeight;
      const cw = uploadBox.clientWidth, ch = uploadBox.clientHeight;
      let drawW = cw, drawH = ch, drawX = 0, drawY = 0;
      if(bw && bh){
        const ratioImg = bw / bh;
        const ratioBox = cw / ch;
        if(ratioImg > ratioBox){
          drawW = cw; drawH = cw / ratioImg; drawX = 0; drawY = (ch - drawH) / 2;
        } else {
          drawH = ch; drawW = ch * ratioImg; drawY = 0; drawX = (cw - drawW) / 2;
        }
        ctx.drawImage(bgImage, drawX, drawY, drawW, drawH);
      }
    }

    // draw stickers
    document.querySelectorAll('.sticker-wrapper').forEach(w => {
      const img = w.querySelector('img');
      if(!img || !img.naturalWidth) return;
      const x = parseInt(w.style.left) || 0;
      const y = parseInt(w.style.top)  || 0;
      const wdt = w.offsetWidth;
      const hgt = img.naturalHeight * (wdt / img.naturalWidth);
      const angle = Number(w.dataset.rotate || 0) * Math.PI / 180;
      if(angle !== 0){
        ctx.save();
        const cx = x + wdt/2;
        const cy = y + hgt/2;
        ctx.translate(cx, cy);
        ctx.rotate(angle);
        ctx.drawImage(img, -wdt/2, -hgt/2, wdt, hgt);
        ctx.restore();
      } else {
        ctx.drawImage(img, x, y, wdt, hgt);
      }
    });

    const link = document.createElement('a');
    link.href = canvas.toDataURL('image/png');
    link.download = 'final_image.png';
    link.click();
  });
  /* CAMERA */
const cameraBtn = document.getElementById('cameraBtn');
const cameraModal = document.getElementById('camera-modal');
const video = document.getElementById('camera-video');

let cameraStream = null;

cameraBtn.addEventListener('click', async () => {
  cameraModal.style.display = 'flex';
  cameraStream = await navigator.mediaDevices.getUserMedia({ video:true });
  video.srcObject = cameraStream;
});

document.getElementById('closeCameraBtn').addEventListener('click', () => {
  cameraModal.style.display = 'none';
  if(cameraStream){
    cameraStream.getTracks().forEach(t => t.stop());
    cameraStream = null;
  }
});

document.getElementById('captureBtn').addEventListener('click', () => {
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);

  // ğŸ”¥ ê¸°ì¡´ ì—…ë¡œë“œë‘ ë™ì¼í•œ bg-imageì— ë„£ê¸°
  document.getElementById('bg-image').src = canvas.toDataURL('image/png');

  cameraModal.style.display = 'none';
  cameraStream.getTracks().forEach(t => t.stop());
  cameraStream = null;
});


  

  console.log('script initialized');
}); // DOMContentLoaded end
</script>
<!-- CAMERA MODAL -->
<div id="camera-modal">
  <div id="camera-box">
    <video id="camera-video" autoplay playsinline></video>
    <div style="text-align:center;">
      <button id="captureBtn">Capture</button>
      <button id="closeCameraBtn">Close</button>
    </div>
  </div>
</div>

</body>
</html>
